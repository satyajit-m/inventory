# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  test:
    # The type of runner that the job will run on
		runs-on: ubuntu-latest
		services: 
			db:
				image: postgres:11
				ports: ['5432:5432']
				options: >-
					--health-cmd pg_isready
					--health-interval 10s
					--health-timeout 5s
					--health-retries 5
			redis:
				image: redis
				ports: ['6379':'6379']
				options: --entry redis-server

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      # Runs a single command using the runners shell
      - name: Setup Ruby
				uses: actions/checkout@v2
				with:
					ruby-version: 2.6.x
			- uses: borales/actions-yarn@v2.0.0
				with:
					cmd: install
			- name: Build and Run tests
				env:
					DATABASE_URL: postgres://postgres:@localhost:5432/test
					REDIS_URL: redis://localhost:6379/0
					RAILS_ENV: test
					RAILS_MASTER_KEY: ${{ secret.RAILS_MASTER_KEY}}
				run: |
					sudo-apt-get -yqq install libpq-dev
					gem install bundler
					bundle install --jobs 4 retry 3
					bundle exec rails db:prepare
					bundle exec rails test




				
